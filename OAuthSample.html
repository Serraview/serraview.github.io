<!-- 
    This sample demonstrates how to authenticate with Serraview via OAuth2 and make subsequent API calls.
-->
<html>
<head>
    <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/oidc-client/1.2.2/oidc-client.js"></script>
</head>

<body>
    <h1 class="js-user"></h1>
    <button class="js-login">Login</button>
    <button class="js-login-popup">Login Popup</button>

    <script>
    // REPLACE: Your Wayfinder URL.
    var wayfinderUrl = 'https://serraview-develop-nightly.dev.serraview.com';

    var settings = {
        authority: wayfinderUrl,
        // REPLACE: Your client id. SELECT * FROM ufn_GetOAuthClient()
        // This client id needs to be associated with an OAuthClientWeb entry that also includes
        // the URL where this page is hosted in the OAuthClientRedirectUris. Redirect URIs are restricted for
        // security.
        // If this page is hosted at https://*.serraview.com/*, then you can use the client_id '4kJ8-lQZT0-Oc--WZ3xRxg'.
        client_id: '4kJ8-lQZT0-Oc--WZ3xRxg',
        response_type: 'token',
        // Add any secured actions you need here by prepending the secured action id with 'com.serraview.wf.sa.'
        scope: 'email com.serraview.wf.sa.2151',
        popup_redirect_uri: window.location.href,
        redirect_uri: window.location.href
    };

    var manager = new Oidc.UserManager(settings);
    var user;

    Oidc.Log.logger = console;

    manager.events.addUserLoaded(function(data){
        var headers = {};

        if (data && data.access_token) {
            // Attach the access token to authorize the upcoming API call.
            headers['Authorization'] = 'Bearer ' + data.access_token;
        }

        // Now that we're authenticated, call the 'whoami' API.
        // This could be replaced with calls to other APIs.
        $.ajax({
            url: wayfinderUrl + '/api/v2/whoami', 
            method: 'GET',
            dataType: 'json',
            headers: headers
        }).done(function(response){
                // Do something with the result of the api call.
                $('.js-user').text('Hello ' + response.fullName);
            });
        });

    $('.js-login').on('click', function () {
        manager
            .signinRedirect()
            .catch(function (error) {
                console.error('error while logging in through the redirect', error);
            });
    });

    $('.js-login-popup').on('click', function () {
        manager
            .signinPopup()
            .catch(function (error) {
                console.error('error while logging in through the popup', error);
            });
    });

    manager.signinRedirectCallback();
    manager.signinPopupCallback();
    </script>
</body>
</html>